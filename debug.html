<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pi Debug ‚Äì TravelPoint</title>

  <!-- Pi SDK (–Ω—É–∂–Ω–æ –æ—Ç–∫—Ä—ã–≤–∞—Ç—å –≤ Pi Browser!) -->
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>

  <style>
    body{font-family:system-ui,Arial,sans-serif;padding:24px;max-width:760px;margin:0 auto}
    h1{font-size:20px}
    button{padding:12px 16px;margin:8px 6px;font-size:16px;border-radius:10px;cursor:pointer}
    #out{white-space:pre-wrap;background:#f7f7f7;border:1px solid #eee;padding:12px;border-radius:8px;margin-top:12px;min-height:120px}
    .row{margin:10px 0}
  </style>
</head>
<body>
  <h1>Pi Debug (Testnet)</h1>
  <p>–û—Ç–∫—Ä–æ–π—Ç–µ –≠–¢–£ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤ <b>Pi Browser</b>. –ö–Ω–æ–ø–∫–∞–º–∏ –Ω–∏–∂–µ –ø—Ä–æ–≤–µ—Ä–∏–º –∫–ª–∏–∫–∏, –∑–∞–≥—Ä—É–∑–∫—É SDK –∏ –ª–æ–≥–∏–Ω.</p>

  <div class="row">
    <button id="btnClick" type="button">1) Test Click</button>
    <button id="btnCheck" type="button">2) Check SDK</button>
    <button id="btnLogin" type="button">3) Login with Pi (sandbox)</button>
  </div>

  <div class="row">
    <button id="btnPay" type="button">4) Pay 0.001 Pi (test)</button>
  </div>

  <pre id="out">Logs:
</pre>

  <script>
    // ---------- helpers ----------
    function out(){ 
      var el = document.getElementById('out');
      var line = Array.prototype.map.call(arguments, function(a){
        try{ return (typeof a==='object') ? JSON.stringify(a, null, 2) : String(a); }
        catch(e){ return String(a); }
      }).join(' ');
      el.textContent += line + "\n";
    }
    function setStatus(msg){ out("[STATUS]", msg); }

    // ---------- wire UI ----------
    document.getElementById('btnClick').addEventListener('click', function(){
      alert('Click works ‚úÖ');
      out('click: OK');
    });

    document.getElementById('btnCheck').addEventListener('click', function(){
      out('window.Pi =', !!window.Pi);
      if (!window.Pi) {
        out('‚ùå Pi SDK not found ‚Äî –æ—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤ Pi Browser.');
        return;
      }
      try {
        Pi.init({ version: '2.0', sandbox: true }); // TESTNET ‚Üí sandbox:true
        out('Pi.init done (sandbox:true) ‚úÖ');
      } catch(e){
        out('Pi.init error:', { message: e && e.message });
      }
    });

    // –ì–ª–æ–±–∞–ª—å–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ—Å–ª–µ –ª–æ–≥–∏–Ω–∞
    var currentUser = null;

    document.getElementById('btnLogin').addEventListener('click', async function(){
      out('login button pressed');
      if (!window.Pi) { alert('No Pi SDK'); out('No Pi SDK'); return; }
      try {
        Pi.init({ version: '2.0', sandbox: true }); // –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
        var scopes = ['username','payments'];
        var auth = await Pi.authenticate(scopes, function(p){ out('onIncompletePaymentFound', p); });
        currentUser = auth && auth.user;
        out('AUTH OK ‚úÖ', auth);
        alert('Authenticated as @' + (currentUser && currentUser.username));
      } catch (e) {
        out('AUTH ERROR ‚ùå', {
          name: e && e.name,
          message: e && e.message,
          code: e && e.code
        });
        alert('Auth error: ' + (e && (e.code  e.message)  'unknown'));
      }
    });

    // TEST payment (–ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤—è–∑–∏ —Å /api/approve –∏ /api/complete)
    document.getElementById('btnPay').addEventListener('click', async function(){
      out('pay button pressed');
      if (!window.Pi) { out('No Pi SDK'); return; }
      if (!currentUser) { out('Please login first.'); alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ Login'); return; }

      try {
        await Pi.createPayment({
          amount: 0.001,
          memo: 'TravelPoint PiNet verification',
          metadata: { orderId: Date.now() }
        }, {
          onReadyForServerApproval: async function (paymentId) {
            out('onReadyForServerApproval paymentId:', paymentId);
            try {
              var r = await fetch('/api/approve', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ paymentId: paymentId })
              });
              var txt = await r.text();
              out('/api/approve ->', r.status, txt);
              if (!r.ok) throw new Error(txt);
              setStatus('Approved by server. Waiting for blockchain tx‚Ä¶');
            } catch (e) {
              out('approve error:', e && (e.message || String(e)));
              alert('Approve failed: ' + (e && (e.message || String(e))));
            }
          },
          onReadyForServerCompletion: async function (paymentId, txid) {
            out('onReadyForServerCompletion', { paymentId: paymentId, txid: txid });
            try {
              var r = await fetch('/api/complete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ paymentId: paymentId, txid: txid })
              });
              var txt = await r.text();
              out('/api/complete ->', r.status, txt);
              if (!r.ok) throw new Error(txt);
              setStatus('üéâ Payment completed!');
              alert('Payment completed!');
            } catch (e) {
              out('complete error:', e && (e.message || String(e)));
              alert('Complete failed: ' + (e && (e.message || String(e))));
            }
          },
          onCancel: function(){ out('Payment canceled'); },
          onError: function(err){ out('Payment error', err && (err.message || String(err))); }
        });
      } catch (err) {
        out('createPayment error:', err && (err.message || String(err)));
      }
    });
  </script>
</body>
</html>
