<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TravelPoint Pi ‚Äî Test</title>

  <!-- CSP: —Ä–∞–∑—Ä–µ—à–∞–µ–º –Ω–∞—à inline-—Å–∫—Ä–∏–ø—Ç –∏ Pi SDK -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 script-src 'self' https://sdk.minepi.com 'unsafe-inline';
                 connect-src 'self' https://api.minepi.com;
                 img-src 'self' data:;
                 style-src 'self' 'unsafe-inline';">

  <style>
    html,body{margin:0;padding:0;font-family:system-ui,Arial,sans-serif}
    .wrap{max-width:680px;margin:32px auto;padding:0 16px;text-align:center}
    button{
      font-size:16px;padding:12px 18px;margin:10px;border:1px solid #ccc;
      border-radius:10px;cursor:pointer;display:inline-block
    }
    #status{margin-top:16px;color:#444}
    /* –∑–∞—â–∏—Ç–∏–º—Å—è –æ—Ç ¬´–ø—Ä–æ–∑—Ä–∞—á–Ω–æ–≥–æ —Å–ª–æ—è¬ª –ø–æ–≤–µ—Ä—Ö —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
    body,*{pointer-events:auto}
  </style>

  <!-- Pi SDK -->
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
</head>
<body>
  <div class="wrap">
    <h1>TravelPoint Pi</h1>
    <p>Use <b>Pi Browser</b> to test a tiny payment flow.</p>

    <button id="btnLogin" onclick="login()">üîë Login with Pi</button>
    <button id="btnPay"   onclick="pay()">üí≥ Pay 0.001 Pi (test)</button>

    <div id="status">Booting‚Ä¶</div>
  </div>

 <script>
  // ===== helpers =====
  function setStatus(msg){ document.getElementById('status')?.textContent = msg; }

  // incomplete payments callback (–Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ —Ä–∞–Ω—å—à–µ –æ–ø–ª–∞—Ç–∞ –∑–∞–≤–∏—Å–ª–∞)
  function onIncompletePaymentFound(payment) {
    console.log("Incomplete payment:", payment);
    setStatus("Found incomplete payment; you can try again.");
  }

  // ===== init SDK =====
  document.addEventListener("DOMContentLoaded", () => {
    if (!window.Pi) {
      setStatus("‚ùå Pi SDK not found. Open this page in Pi Browser.");
      return;
    }
    // –¢–µ—Å—Ç–æ–≤–∞—è —Å—Ä–µ–¥–∞ ‚Üí sandbox: true (–¥–ª—è Mainnet –ø–æ—Å—Ç–∞–≤–∏—à—å false)
    Pi.init({ version: "2.0", sandbox: true });
    setStatus("‚úÖ Pi SDK connected. Please Login first.");
  });

  // ===== REAL LOGIN =====
  async function login() {
    try {
      const scopes = ["username", "payments"];
      const auth = await Pi.authenticate(scopes, onIncompletePaymentFound);
      // —Å–æ—Ö—Ä–∞–Ω–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≥–ª–æ–±–∞–ª—å–Ω–æ ‚Äî –ø—Ä–∏–≥–æ–¥–∏—Ç—Å—è –¥–ª—è –ø–ª–∞—Ç–µ–∂–∞
      window.__piUser = auth.user;
      setStatus(‚úÖ Logged in as @${auth.user.username});
      console.log("Auth result:", auth);
    } catch (err) {
      console.error("Pi.authenticate error:", err);
      setStatus("Login error: " + (err?.message ?? "Unknown"));
      alert("Login failed: " + (err?.message ?? "Unknown"));
    }
  }

  // ===== PAYMENT (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, –µ—Å–ª–∏ —É–∂–µ —Ä–∞–±–æ—Ç–∞–ª–æ) =====
  async function pay() {
    if (!window.__piUser) {
      setStatus("Please login first.");
      return;
    }
    try {
      const payment = await Pi.createPayment({
        amount: 0.001,
        memo: "TravelPoint PiNet verification",
        metadata: { orderId: Date.now() }
      }, {
        onReadyForServerApproval: async (paymentId) => {
          try {
            const r = await fetch("/api/approve", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ paymentId })
            });
            if (!r.ok) throw await r.text();
            setStatus("‚úÖ Approved by server. Awaiting blockchain tx‚Ä¶");
          } catch (e) {
            console.error(e);
            setStatus("Server approval failed.");
          }
        },
        onReadyForServerCompletion: async (paymentId, txid) => {
          try {
            const r = await fetch("/api/complete", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ paymentId, txid })
            });
            if (!r.ok) throw await r.text();
            setStatus("üéâ Payment completed! You can finish Step 10.");
            alert("Payment completed successfully!");
          } catch (e) {
            console.error(e);
            setStatus("Server completion failed.");
          }
        },
        onCancel: () => setStatus("Payment canceled."),
        onError: (err) => {
          console.error(err);
          setStatus("Payment error: " + (err?.message ?? "Unknown"));
        }
      });

      console.log("payment obj:", payment);
    } catch (err) {
      console.error(err);
      setStatus("CreatePayment failed.");
    }
  }

  // –æ—Ç–∫—Ä–æ–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —Å onclick="..."
  window.login = login;
  
  window.pay = pay;
</script>
</body>
</html>
