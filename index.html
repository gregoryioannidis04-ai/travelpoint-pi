<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>TravelPoint Pi</title>
<script src="https://sdk.minepi.com/pi-sdk.js"></script>
<style>
  body { font-family: system-ui, Arial; text-align:center; padding:40px; }
  button { padding:12px 18px; margin:10px; font-size:16px; border-radius:10px; cursor:pointer; }
  button[disabled]{ opacity: .5; cursor: not-allowed; }
  #log{ white-space:pre-wrap; max-width:680px; margin:18px auto; text-align:left; border:1px solid #ddd; border-radius:10px; padding:10px; display:none;}
</style>
</head>
<body>
  <h2>TravelPoint Pi</h2>
  <p>Use <b>Pi Browser</b> to test a tiny payment flow.</p>

  <button id="btnLogin" type="button">üîë Login with Pi</button>
  <button id="btnPay"   type="button" disabled>üí≥ Pay 0.001 Pi (test)</button>

  <div id="status">Booting‚Ä¶</div>
  <div id="log"></div>

<script>
(function(){
  const S = (t)=> document.getElementById('status').textContent = t;
  const logBox = document.getElementById('log');
  const log = (msg)=>{ logBox.style.display='block'; logBox.textContent += msg + "\n"; console.log(msg); };

  const btnLogin = document.getElementById('btnLogin');
  const btnPay   = document.getElementById('btnPay');

  // 0) –ü—Ä–æ–≤–µ—Ä—è–µ–º SDK
  if(!window.Pi){
    S("‚ùå Pi SDK not found. Open this page in Pi Browser.");
    btnLogin.disabled = btnPay.disabled = true;
    return;
  }

  // 1) –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è SDK (TESTNET!)
  try{
    Pi.init({ version:"2.0", sandbox:true });
    S("‚úÖ Pi SDK initialized (sandbox).");
  }catch(e){
    S("‚ùå Pi.init error: " + (e?.message||e));
    return;
  }

  // helper: –≤–∫–ª—é—á–∏—Ç—å –æ–ø–ª–∞—Ç—É, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å scope payments
  function enablePayIfHasPaymentsScope(auth){
    const scopes = auth?.scopes || [];
    const hasPayments = scopes.includes('payments');
    btnPay.disabled = !hasPayments;
    log("Scopes: " + JSON.stringify(scopes));
    if(hasPayments){
      S("‚úÖ Logged in as @" + (auth?.user?.username || "?") + " (payments scope granted)");
    }else{
      S("‚ö†Ô∏è Logged in, but no 'payments' scope. Tap Login again and allow permissions.");
    }
  }

  // 2) –ê–≤—Ç–æ-–ª–æ–≥–∏–Ω –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ (–º—è–≥–∫–∞—è –ø–æ–ø—ã—Ç–∫–∞)
  (async ()=>{
    try{
      const auth = await Pi.authenticate(['username','payments'], (p)=>log("onIncompletePaymentFound: " + JSON.stringify(p)));
      log("Auto-auth OK: " + JSON.stringify({user:auth?.user?.username, scopes:auth?.scopes}));
      enablePayIfHasPaymentsScope(auth);
    }catch(e){
      // –≠—Ç–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–º—ë—Ç Login
      log("Auto-auth skipped: " + (e?.message||e));
      S("Please tap ‚ÄòLogin with Pi‚Äô to continue.");
      btnPay.disabled = true;
    }
  })();

  // 3) –†—É—á–Ω–æ–π –ª–æ–≥–∏–Ω
  btnLogin.addEventListener('click', async ()=>{
    alert("Login button clicked"); // –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∫–ª–∏–∫–∞
    try{
      const auth = await Pi.authenticate(['username','payments'], (p)=>log("onIncompletePaymentFound: " + JSON.stringify(p)));
      log("Manual auth OK: " + JSON.stringify({user:auth?.user?.username, scopes:auth?.scopes}));
      enablePayIfHasPaymentsScope(auth);
    }catch(e){
      log("‚ùå Login error: " + (e?.message||e));
      S("Login failed: " + (e?.codee?.message'unknown'));
      btnPay.disabled = true;
      alert("Login failed: " + (e?.codee?.message'unknown'));
    }
  });

  // 4) –û–ø–ª–∞—Ç–∞ (–¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ payments)
  btnPay.addEventListener('click', async ()=>{
    if(btnPay.disabled){
      alert("Please Login first and allow ‚Äòpayments‚Äô permission.");
      return;
    }
    try{
      const payment = await Pi.createPayment({
        amount: 0.001,
        memo: "TravelPoint Test Payment",
        metadata: { source: "index.html" }
      },{
        onReadyForServerApproval: (paymentId)=>{ log("onReadyForServerApproval: " + paymentId); },
        onReadyForServerCompletion:(paymentId)=>{ log("onReadyForServerCompletion: " + paymentId); },
        onCancel: (paymentId)=>{ log("onCancel: " + paymentId); S("Payment canceled."); },
        onError:  (error, payment)=>{ log("onError: " + (error?.messageerror)); S("Payment error: " + (error?.messageerror)); }
      });
      log("Payment result: " + JSON.stringify(payment));
      S("Payment flow finished.");
    }catch(e){
      log("‚ùå Payment create error: " + (e?.message||e));
      S("Payment failed: " + (e?.message||e));
      alert("Payment error: " + (e?.message||e));
    }
  });

})();
</script>
</body>
</html>
