<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TravelPoint Pi</title>

  <!-- Pi SDK -->
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>

  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin: 50px 16px; }
    button { padding: 10px 20px; margin: 10px; font-size: 16px; cursor: pointer; }
    #status { margin: 12px 0 24px; font-size: 14px; color: #555; white-space: pre-line; }
    .ok { color:#0a7; } .err { color:#c00; }
  </style>
</head>
<body>
  <h1>Welcome to TravelPoint Pi</h1>
  <p>Login and test Pi payments</p>

  <div id="status">Initializingâ€¦</div>

  <button id="btnLogin">ðŸ”‘ Login with Pi</button>
  <button id="btnPay">ðŸ’³ Pay 1 Pi (Test)</button>
  <button onclick="alert('JS is working')">ðŸ§ª Test JS</button>

  <script>
    // ÐŸÐ¸ÑˆÐµÐ¼ Ð²ÑÑ‘ Ð½Ð° ÑÐºÑ€Ð°Ð½, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð²Ð¸Ð´ÐµÑ‚ÑŒ, Ð³Ð´Ðµ ÑÑ‚Ð¾Ð¿Ð¾Ñ€
    const statusEl = document.getElementById('status');
    const log = (msg, cls) => {
      statusEl.className = cls || '';
      statusEl.textContent = msg;
    };

    window.onerror = function (msg, src, line, col, err) {
      log(JS error:\n${msg}\n${src}:${line}:${col}, 'err');
      return false;
    };

    function showErr(err, where) {
      const msg = err?.message  err?.error  err?.code || JSON.stringify(err);
      alert(${where} error:\n${msg});
      console.error(where, err);
      log(${where} error:\n${msg}, 'err');
    }

    window.__piUser = null;

    // Ð’ÐµÑˆÐ°ÐµÐ¼ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸ÐºÐ¸ Ñ‡ÐµÑ€ÐµÐ· JS (Ð±ÐµÐ· inline)
    document.getElementById('btnLogin').addEventListener('click', login);
    document.getElementById('btnPay').addEventListener('click', pay);

    // Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ
    (function init() {
      try {
        if (!window.Pi) {
          log('Pi SDK not found.\nOpen this page in the Pi Browser (and enable Sandbox).', 'err');
          return;
        }
        // sandbox: true â€” Ð´Ð»Ñ Ñ‚ÐµÑÑ‚Ð¾Ð²Ð¾Ð¹ ÑÐµÑ‚Ð¸
        Pi.init({ version: '2.0', sandbox: true });
        console.log('âœ… Pi SDK connected (sandbox)');
        log('âœ… Pi SDK connected (sandbox)', 'ok');
      } catch (e) {
        showErr(e, 'Pi.init');
      }
    })();

    // ÐÐ° ÑÐ»ÑƒÑ‡Ð°Ð¹ Ð½ÐµÐ·Ð°Ð²ÐµÑ€ÑˆÑ‘Ð½Ð½Ñ‹Ñ… Ð¿Ð»Ð°Ñ‚ÐµÐ¶ÐµÐ¹
    function onIncompletePaymentFound(payment) {
      console.log('Incomplete payment found:', payment);
    }

    // Ð›Ð¾Ð³Ð¸Ð½
    async function login() {
      try {
        if (!window.Pi) { alert('Pi SDK not found. Open in Pi Browser.'); return; }
        log('Authenticatingâ€¦');
        const scopes = ['username', 'payments'];
        const auth = await Pi.authenticate(scopes, onIncompletePaymentFound);
        window.__piUser = auth?.user || null;
        alert('Logged in as: ' + (window.__piUser?.username || 'unknown'));
        console.log('Auth:', auth);
        log('Logged in', 'ok');
      } catch (err) {
        showErr(err, 'Login');
      }
    }

    // ÐŸÐ»Ð°Ñ‚Ñ‘Ð¶ (testnet)
    async function pay() {
      try {
        if (!window.Pi) { alert('Pi SDK not found. Open in Pi Browser.'); return; }
        if (!window.__piUser) {
          alert("Please login first (press 'Login with Pi').");
          return;
        }
        log('Creating paymentâ€¦');

        await Pi.createPayment(
          {
            amount: 1,
            memo: 'TravelPoint test payment',
            metadata: { orderId: Date.now() }
          },
          {
            onReadyForServerApproval: async (paymentId) => {
              try {
                const res = await fetch('/api/approve', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ paymentId })
                });
                const body = await res.json().catch(() => ({}));
                if (!res.ok) throw body;
                alert('Server approved: ' + paymentId);
                } catch (err) {
                showErr(err, 'Server approval (/api/approve)');
              }
            },
            onReadyForServerCompletion: async (paymentId, txid) => {
              try {
                const res = await fetch('/api/complete', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ paymentId, txid })
                });
                const body = await res.json().catch(() => ({}));
                if (!res.ok) throw body;
                alert('Server completed: ' + paymentId);
              } catch (err) {
                showErr(err, 'Server completion (/api/complete)');
              }
            },
            onCancel: (paymentId) => { alert('Canceled: ' + paymentId); },
            onError:  (err)       => { showErr(err, 'Payment'); }
          }
        );

        log('Payment flow finished (see alerts/logs)', 'ok');
      } catch (err) {
        showErr(err, 'CreatePayment');
      }
    }
  </script>
</body>
</html>
