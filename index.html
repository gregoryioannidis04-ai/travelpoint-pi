<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TravelPoint Pi ‚Äì Test Payment</title>

  <!-- Pi SDK -->
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>

  <style>
    body { font-family: system-ui, Arial, sans-serif; padding: 32px; text-align: center; }
    h1 { margin-bottom: 8px; }
    p  { color:#444; }
    button {
      font-size: 16px; padding: 12px 18px; margin: 10px;
      border: 1px solid #ccc; border-radius: 10px; cursor: pointer;
    }
    #status { margin-top:18px; font-size:14px; color:#555; }
  </style>
</head>
<body>
  <h1>TravelPoint Pi</h1>
  <p>Tap the buttons below in <b>Pi Browser</b> to complete the verification payment.</p>

 <div>
  <button type="button" id="btnLogin">üîë Login with Pi</button>
  <button type="button" id="btnPay">üí≥ Pay 0.001 Pi (test)</button>
</div>

  <div id="status">Initializing‚Ä¶</div>

<script src="https://sdk.minepi.com/pi-sdk.js?v=20251011"></script>
<script>
  // —Å—Ç–∞—Ç—É—Å –≤–Ω–∏–∑—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  function setStatus(msg){ 
    const el = document.getElementById('status'); 
    if (el) el.textContent = msg; 
  }

  // –ì–õ–ê–í–ù–û–ï: –¥–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –≥–ª–æ–±–∞–ª—å–Ω—ã–º–∏
  window.login = async function login() {
    try {
      if (!window.Pi) { setStatus("‚ùå Pi SDK not found."); return; }
      const scopes = ["username","payments"];
      const auth = await Pi.authenticate(scopes, (payment) => {
        console.log("Incomplete payment:", payment);
        setStatus("Found incomplete payment; try again.");
      });
      window.__piUser = auth.user;
      setStatus("Logged in as @" + auth.user.username);
    } catch (err) {
      console.error("Login error:", err);
      setStatus("Login error: " + (err?.message ?? "Unknown"));
      alert("Login error: " + (err?.message ?? "Unknown"));
    }
  };

  window.pay = async function pay() {
    try {
      if (!window.__piUser) { setStatus("Please login first."); return; }
      const payment = await Pi.createPayment({
        amount: 0.001,
        memo: "TravelPoint PiNet verification",
        metadata: { orderId: Date.now() }
      }, {
        onReadyForServerApproval: async (paymentId) => {
          try {
            const r = await fetch("/api/approve", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ paymentId })
            });
            if (!r.ok) throw await r.text();
            setStatus("‚úÖ Approved by server. Awaiting blockchain tx‚Ä¶");
          } catch (e) {
            console.error("approve error:", e);
            setStatus("Server approval failed.");
            alert("Approve failed: " + e);
          }
        },
        onReadyForServerCompletion: async (paymentId, txid) => {
          try {
            const r = await fetch("/api/complete", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ paymentId, txid })
            });
            if (!r.ok) throw await r.text();
            setStatus("üéâ Payment completed!");
            alert("Payment completed successfully!");
          } catch (e) {
            console.error("complete error:", e);
            setStatus("Server completion failed.");
            alert("Complete failed: " + e);
          }
        },
        onCancel: () => setStatus("Payment canceled."),
        onError: (err) => {
          console.error("payment error:", err);
          setStatus("Payment error: " + (err?.message ?? "Unknown"));
        }
      });
      console.log("payment obj:", payment);
    } catch (err) {
      console.error("createPayment failed:", err);
      setStatus("CreatePayment failed.");
      alert("CreatePayment failed: " + (err?.message ?? "Unknown"));
    }
  };

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è SDK ‚Äî –¥–ª—è Testnet –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û sandbox:true
  document.addEventListener("DOMContentLoaded", () => {
    try {
      if (!window.Pi) {
        setStatus("‚ùå Pi SDK not found (open in Pi Browser).");
        return;
      }
      Pi.init({ version: "2.0", sandbox: true });  // <‚Äî –í–ê–ñ–ù–û –¥–ª—è Testnet
      setStatus("‚úÖ Pi SDK connected. Please Login first.");
    } catch (e) {
      console.error("Pi.init error:", e);
      setStatus("Pi.init error");
    }
  });
</script>
</body>
</html>
