<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>TravelPoint Pi</title>
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
  <style>
    body {font-family: system-ui, Arial, sans-serif; padding: 24px; text-align:center}
    h1 {margin: 12px 0 6px}
    button {font-size:16px; padding:12px 18px; margin:10px; border:1px solid #ccc; border-radius:12px; cursor:pointer}
    #log {white-space:pre-wrap; text-align:left; max-width:680px; margin:18px auto; padding:12px; border:1px dashed #bbb; border-radius:12px; background:#fafafa}
  </style>
</head>
<body>
  <h1>TravelPoint Pi</h1>
  <p>Use <b>Pi Browser</b> to test a tiny payment flow.</p>

  <div>
    <button id="btnLogin" type="button">ðŸ”‘ Login with Pi</button>
    <button id="btnPay"   type="button">ðŸ’³ Pay 0.001 Pi (test)</button>
  </div>

  <p id="status">Bootingâ€¦</p>
  <div id="log"></div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const log = (msg,obj)=>{
    const line = (typeof msg==='string'?msg:JSON.stringify(msg));
    $('log').textContent += line + (obj? ' ' + JSON.stringify(obj,null,2):'') + '\n';
  };
  const setStatus = (s)=> $('status').textContent = s;

  // Ð”Ð¸Ð°Ð³Ð½Ð¾ÑÑ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð³Ð»Ð¾Ð±Ð°Ð»ÑŒÐ½Ñ‹Ð¹ ÐºÐ»Ð¸Ðº â€” ÑÑ€Ð°Ð·Ñƒ Ð¿Ð¾ÐºÐ°Ð¶ÐµÑ‚, Ð´Ð¾Ñ…Ð¾Ð´ÑÑ‚ Ð»Ð¸ ÐºÐ»Ð¸ÐºÐ¸ Ð²Ð¾Ð¾Ð±Ñ‰Ðµ
  document.addEventListener('click', (e)=>{
    if(!window.__clickedOnce){
      window.__clickedOnce = true;
      alert('Click captured âœ…');
      log('click captured âœ…');
    }
  }, {once:true});

  // Ð”ÑƒÐ±Ð»Ð¸Ñ€ÑƒÐµÐ¼ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸ÐºÐ¸ "Ð² Ð»Ð¾Ð±", ÐµÑÐ»Ð¸ Ð±Ñ€Ð°ÑƒÐ·ÐµÑ€ Ð²Ð´Ñ€ÑƒÐ³ Ð¸Ð³Ð½Ð¾Ñ€Ð¸Ñ‚ addEventListener
  $('btnLogin').setAttribute('onclick','window.login && window.login()');
  $('btnPay').setAttribute('onclick','window.pay && window.pay()');

  // ÐžÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸ÐºÐ¸
  window.__login = async function(){
    log('login pressed');
    try{
      const scopes = ['username','payments'];
      const auth = await Pi.authenticate(scopes, (p)=>log('onIncompletePaymentFound',p));
      log('AUTH OK âœ…', auth);
      setStatus('Logged in as @'+ (auth?.user?.username||'unknown'));
      alert('Logged in as @'+(auth?.user?.username||'unknown'));
    }catch(e){
      log('AUTH ERROR âŒ', {name:e?.name, code:e?.code, message:e?.message});
      alert('Auth error: ' + (e?.codee?.message'unknown'));
    }
  };

  window.__pay = async function(){
    log('pay pressed');
    if(!window.__loggedWarned && (!window.Pi || !Pi?.authenticate)){
      alert('Pi SDK not ready. Reload in Pi Browser.');
      return;
    }
    try{
      const payment = await Pi.createPayment({
        amount: 0.001,
        memo: 'TravelPoint PiNet verification',
        metadata: { ts: Date.now() }
      },{
        onReadyForServerApproval: async (paymentId)=>{
          log('onReadyForServerApproval', {paymentId});
          try{
            const r = await fetch('/api/approve', {
              method:'POST',
              headers:{'Content-Type':'application/json'},
              body: JSON.stringify({paymentId})
            });
            const t = await r.text();
            log('approve â†’', {status:r.status, body:t});
            if(!r.ok) throw new Error('Approve failed '+r.status);
            setStatus('Approved by server. Awaiting blockchain txâ€¦');
          }catch(e){ log('approve error', e); alert('Approve failed'); }
        },
        onReadyForServerCompletion: async (paymentId, txid)=>{
          log('onReadyForServerCompletion', {paymentId, txid});
          try{
            const r = await fetch('/api/complete', {
              method:'POST',
              headers:{'Content-Type':'application/json'},
              body: JSON.stringify({paymentId, txid})
            });
            const t = await r.text();
            log('complete â†’', {status:r.status, body:t});
            if(!r.ok) throw new Error('Complete failed '+r.status);
            setStatus('ðŸŽ‰ Payment completed!');
            alert('Payment completed!');
          }catch(e){ log('complete error', e); alert('Complete failed'); }
        },
        onCancel: (paymentId)=>{ log('onCancel', {paymentId}); setStatus('Payment canceled'); },
        onError: (err, paymentId)=>{ log('onError', {err, paymentId}); setStatus('Payment error'); }
      });
      log('createPayment returned', payment);
    }catch(e){
      log('createPayment error', {name:e?.name, code:e?.code, message:e?.message});
      alert('createPayment error: ' + (e?.codee?.message'unknown'));
    }
  };

  // Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ SDK (TESTNET!)
  function init(){
    if(!window.Pi){
      setStatus('âŒ Pi SDK not found. Open IN Pi Browser.');
      log('Pi SDK not found');
      return;
    }
    try{
      Pi.init({version:'2.0', sandbox:true}); // Testnet = true
      setStatus('âœ… Pi SDK ready. Please Login first.');
      log('Pi.init done (sandbox:true)');
    }catch(e){
      setStatus('Pi.init error');
      log('Pi.init error', {name:e?.name, code:e?.code, message:e?.message});
    }
  }

  // Ð¡Ñ‚Ð°Ñ€Ñ‚ â€” Ñ‡ÑƒÑ‚ÑŒ Ð¾Ñ‚ÐºÐ»Ð°Ð´Ñ‹Ð²Ð°ÐµÐ¼, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð³Ð°Ñ€Ð°Ð½Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð¾ Ð´Ð¾Ð¶Ð´Ð°Ñ‚ÑŒÑÑ Ð²ÑÑ‚Ð°Ð²ÐºÐ¸ SDK
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', ()=> setTimeout(init, 50));
  }else{
    setTimeout(init, 50);
  }
})();
</script>
</body>
</html>
