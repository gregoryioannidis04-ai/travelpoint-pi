<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TravelPoint Pi ‚Äî Test</title>

  <!-- CSP: —Ä–∞–∑—Ä–µ—à–∞–µ–º –Ω–∞—à inline-—Å–∫—Ä–∏–ø—Ç –∏ Pi SDK -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 script-src 'self' https://sdk.minepi.com 'unsafe-inline';
                 connect-src 'self' https://api.minepi.com;
                 img-src 'self' data:;
                 style-src 'self' 'unsafe-inline';">

  <style>
    html,body{margin:0;padding:0;font-family:system-ui,Arial,sans-serif}
    .wrap{max-width:680px;margin:32px auto;padding:0 16px;text-align:center}
    button{
      font-size:16px;padding:12px 18px;margin:10px;border:1px solid #ccc;
      border-radius:10px;cursor:pointer;display:inline-block
    }
    #status{margin-top:16px;color:#444}
    /* –∑–∞—â–∏—Ç–∏–º—Å—è –æ—Ç ¬´–ø—Ä–æ–∑—Ä–∞—á–Ω–æ–≥–æ —Å–ª–æ—è¬ª –ø–æ–≤–µ—Ä—Ö —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
    body,*{pointer-events:auto}
  </style>

  <!-- Pi SDK -->
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
</head>
<body>
  <div class="wrap">
    <h1>TravelPoint Pi</h1>
    <p>Use <b>Pi Browser</b> to test a tiny payment flow.</p>

    <button id="btnLogin" onclick="login()">üîë Login with Pi</button>
    <button id="btnPay"   onclick="pay()">üí≥ Pay 0.001 Pi (test)</button>

    <div id="status">Booting‚Ä¶</div>
  </div>

  <script>
    // --- —É—Ç–∏–ª–∏—Ç–∞ —Å—Ç–∞—Ç—É—Å–∞ ---
    const setStatus = (msg) => {
      const el = document.getElementById('status');
      if (el) el.textContent = msg;
      console.log('[STATUS]', msg);
    };

    // --- –∑–∞—â–∏—Ç–∞ –æ—Ç "–º–µ—Ä—Ç–≤–æ–π" –∫–Ω–æ–ø–∫–∏: –≥–ª–æ–±–∞–ª—å–Ω—ã–π –ª–æ–≤–µ—Ü –ø–µ—Ä–≤–æ–≥–æ –∫–ª–∏–∫–∞ ---
    document.addEventListener('click', () => {
      if (!window.__firstClick) {
        window.__firstClick = true;
        console.log('[DEBUG] First click detected');
      }
    }, { once: true });

    // --- –Ω–∞–≤–µ—à–∏–≤–∞–µ–º —Å–ª—É—à–∞—Ç–µ–ª–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ (–ø–æ–º–∏–º–æ onclick=) ---
    document.addEventListener('DOMContentLoaded', () => {
      const btnLogin = document.getElementById('btnLogin');
      const btnPay   = document.getElementById('btnPay');
      btnLogin && btnLogin.addEventListener('click', () => login());
      btnPay   && btnPay.addEventListener('click', () => pay());

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Pi SDK
      if (!window.Pi) {
        setStatus('‚ùå Pi SDK not found. Open in Pi Browser.');
        return;
      }
      try {
        // –í —Ç–µ—Å—Ç–Ω–µ—Ç–µ sandbox=true. –í mainnet sandbox=false.
        Pi.init({ version: '2.0', sandbox: true });
        setStatus('‚úÖ Pi SDK connected. Please login first.');
      } catch (e) {
        console.error(e);
        setStatus('‚ùå Pi.init() failed: ' + (e?.message || 'unknown'));
      }
    });

    // --- –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞ ---
    function onIncompletePaymentFound(payment) {
      console.log('[Pi] Incomplete payment found:', payment);
      setStatus('Found incomplete payment. Try again.');
    }

    // --- LOGIN ---
    async function login() {
      alert('Login button clicked'); // —è–≤–Ω—ã–π –ø—Ä–∏–∑–Ω–∞–∫, —á—Ç–æ –∫–ª–∏–∫–∏ –¥–æ—Ö–æ–¥—è—Ç
      try {
        const scopes = ['username','payments'];
        const auth = await Pi.authenticate(scopes, onIncompletePaymentFound);
        window.__piUser = auth?.user;
        setStatus('Logged in as @' + auth?.user?.username);
        console.log('[Pi] Auth:', auth);
      } catch (err) {
        console.error('[Pi] Login error:', err);
        setStatus('Login error: ' + (err?.message || 'unknown'));
      }
    }

    // --- PAY ---
    async function pay() {
      alert('Pay button clicked'); // —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å —Å–∞–º –∫–ª–∏–∫
      if (!window.__piUser) {
        setStatus('Please login first.');
        return;
      }
      try {
        await Pi.createPayment({
          amount: 0.001,
          memo: 'TravelPoint PiNet verification',
          metadata: { orderId: Date.now() }
        }, {
          onReadyForServerApproval: async (paymentId) => {
            console.log('[Pi] onReadyForServerApproval', paymentId);
            try {
              const r = await fetch('/api/approve', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ paymentId })
              });
              if (!r.ok) throw new Error(await r.text());
              setStatus('‚úÖ Approved by server. Waiting for tx‚Ä¶');
            } catch (e) {
              console.error(e);
              setStatus('Server approval failed.');
            }
          },
          onReadyForServerCompletion: async (paymentId, txid) => {
            console.log('[Pi] onReadyForServerCompletion', paymentId, txid);
            try {
              const r = await fetch('/api/complete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ paymentId, txid })
              });
              if (!r.ok) throw new Error(await r.text());
              setStatus('üéâ Payment completed!');
            } catch (e) {
              console.error(e);
              setStatus('Server completion failed.');
            }
          },
          onCancel: () => setStatus('Payment canceled.'),
          onError: (err) => {
            console.error('[Pi] Payment error:', err);
            setStatus('Payment error: ' + (err?.message || 'unknown'));
          }
        });
      } catch (err) {
        console.error('[Pi] createPayment error:', err);
        setStatus('CreatePayment failed.');
      }
    }
  </script>
</body>
</html>
