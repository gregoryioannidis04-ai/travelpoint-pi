<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TravelPoint Pi</title>

  <!-- ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ Pi SDK ÐžÐ”Ð˜Ð Ñ€Ð°Ð· -->
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>

  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin-top: 50px; }
    button { padding: 10px 20px; margin: 10px; font-size: 16px; cursor: pointer; }
    .muted { opacity: 0.6; }
  </style>
</head>
<body>
  <h1>Welcome to TravelPoint Pi</h1>
  <p>Login and test Pi payments</p>

  <button id="btnLogin" onclick="login()">ðŸ”‘ Login with Pi</button>
  <button id="btnPay"   onclick="pay()">ðŸ’³ Pay 1 Pi (Test)</button>

  <script>
    // --- Ð’ÑÐ¿Ð¾Ð¼Ð¾Ð³Ð°Ð»ÐºÐ¸ ---
    function showErr(err, where) {
      const msg = err?.message  err?.error  err?.code || JSON.stringify(err);
      alert(${where} error:\n${msg});
      console.error(where, err);
    }

    function setButtonsEnabled(enabled) {
      const btnLogin = document.getElementById('btnLogin');
      const btnPay   = document.getElementById('btnPay');
      [btnLogin, btnPay].forEach(b => {
        b.disabled = !enabled;
        b.classList.toggle('muted', !enabled);
      });
    }

    // Ð¥Ñ€Ð°Ð½Ð¸Ð¼ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ³Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð¿Ð¾ÑÐ»Ðµ Ð»Ð¾Ð³Ð¸Ð½Ð° (Ð´Ð»Ñ Ð½Ð°Ð³Ð»ÑÐ´Ð½Ð¾ÑÑ‚Ð¸)
    window.__piUser = null;

    // --- Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ SDK (sandbox) Ð¾Ð´Ð¸Ð½ Ñ€Ð°Ð· ---
    window.addEventListener('load', () => {
      setButtonsEnabled(false);
      if (window.Pi) {
        try {
          Pi.init({ version: '2.0', sandbox: true });
          console.log('âœ… Pi SDK connected (sandbox mode)');
          setButtonsEnabled(true);
        } catch (e) {
          showErr(e, 'Pi.init');
        }
      } else {
        console.error('âŒ Pi SDK not found');
        alert('Pi SDK not found. Open this page in the Pi Browser.');
      }
    });

    // --- ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº Ð½ÐµÐ·Ð°Ð²ÐµÑ€ÑˆÑ‘Ð½Ð½Ñ‹Ñ… Ð¿Ð»Ð°Ñ‚ÐµÐ¶ÐµÐ¹ ---
    function onIncompletePaymentFound(payment) {
      console.log('Incomplete payment found:', payment);
      // Ð—Ð´ÐµÑÑŒ Ð¼Ð¾Ð¶Ð½Ð¾ Ð´ÐµÑ€Ð½ÑƒÑ‚ÑŒ Ð²Ð°Ñˆ ÑÐµÑ€Ð²ÐµÑ€ Ð´Ð»Ñ Ð´Ð¾Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ñ, ÐµÑÐ»Ð¸ Ð½ÑƒÐ¶Ð½Ð¾
    }

    // --- Ð›ÐžÐ“Ð˜Ð ---
    async function login() {
      try {
        const scopes = ['username', 'payments'];
        const authResult = await Pi.authenticate(scopes, onIncompletePaymentFound);
        window.__piUser = authResult?.user || null;
        alert('Logged in as: ' + (window.__piUser?.username || 'unknown'));
        console.log('Auth success:', authResult);
      } catch (err) {
        showErr(err, 'Login');
      }
    }

    // --- ÐŸÐ›ÐÐ¢ÐÐ– (TESTNET) ---
    async function pay() {
      try {
        // Ð¢Ñ€ÐµÐ±ÑƒÐµÐ¼ Ð¿Ñ€ÐµÐ´Ð²Ð°Ñ€Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¹ Ð»Ð¾Ð³Ð¸Ð½
        if (!window.__piUser) {
          alert("Please login first (press 'Login with Pi').");
          return;
        }

        const payment = await Pi.createPayment(
          {
            amount: 1,
            memo: 'TravelPoint test payment',
            metadata: { orderId: Date.now() }
          },
          {
            onReadyForServerApproval: async (paymentId) => {
              try {
                const res = await fetch('/api/approve', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ paymentId })
                });
                const body = await res.json().catch(() => ({}));
                if (!res.ok) throw body;
                alert('Server approved: ' + paymentId);
              } catch (err) {
                showErr(err, 'Server approval (/api/approve)');
              }
            },
            onReadyForServerCompletion: async (paymentId, txid) => {
              try {
                const res = await fetch('/api/complete', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ paymentId, txid })
                });
                const body = await res.json().catch(() => ({}));
                if (!res.ok) throw body;
                alert('Server completed: ' + paymentId);
              } catch (err) {
                showErr(err, 'Server completion (/api/complete)');
              }
            },
            onCancel: (paymentId) => {
              alert('Canceled: ' + paymentId);
            },
            onError: (err, paymentId) => {
              showErr(err, 'Payment');
            }
          }
        );

        console.log('Payment object:', payment);
      } catch (err) {
        showErr(err, 'CreatePayment');
      }
    }
  </script>
</body>
</html>
